Consultas Parametrizadas: En lugar de concatenar valores directamente en la consulta SQL, utilizo consultas parametrizadas ($stmt->bind_param) para evitar la inyección SQL.

* Verificación de Contraseñas: Utilizamos la función password_verify() para comparar la contraseña ingresada por el usuario con la contraseña almacenada en la base de datos. Además, se utiliza password_hash() al registrar usuarios para almacenar las contraseñas de forma segura.

 *Eliminación de Variables No Utilizadas: Se eliminaron las variables $sql y $sql2 que no se utilizaban.

 *Seguridad de Sesiones: Las variables de sesión ($_SESSION) se utilizan para almacenar información de usuario sensible de manera segura.

Implemente estos cambios para  sea más seguro y menos vulnerable a ataques como la inyección SQL y el robo de contraseñas.


<?php
session_start();
require("conexion.php");

// Obtener los datos del formulario de manera segura

$username = isset($_POST['mail']) ? $_POST['mail'] : '';
$pass = isset($_POST['pass']) ? $_POST['pass'] : '';

// Preparar la consulta SQL utilizando consultas parametrizadas para evitar inyección SQL

$stmt = $mysqli->prepare("SELECT id, user, rol, password, pasadmin FROM login WHERE email = ?");
$stmt->bind_param("s", $username);
$stmt->execute();
$result = $stmt->get_result();

if ($result->num_rows > 0) {
    $row = $result->fetch_assoc();
    
    // Verificar si el usuario es administrador
    if (!empty($row['pasadmin']) && password_verify($pass, $row['pasadmin'])) {
        // Establecer variables de sesión para el administrador
        $_SESSION['id'] = $row['id'];
        $_SESSION['user'] = $row['user'];
        $_SESSION['rol'] = $row['rol'];
        
        // Redirigir al usuario a la página de administrador
        echo '<script>alert("ADMINISTRADOR")</script>';
        echo "<script>location.href='admin.php'</script>";
        exit();
    }
    
    // Verificar la contraseña del usuario regular

    if (password_verify($pass, $row['password'])) {
        // Establecer variables de sesión para el usuario regular
        $_SESSION['id'] = $row['id'];
        $_SESSION['user'] = $row['user'];
        $_SESSION['rol'] = $row['rol'];
        
        // Redirigir al usuario a la página de inicio
        header("Location: inicio.php");
        exit();
    } else {
        // Contraseña incorrecta para el usuario regular
        echo '<script>alert("CONTRASEÑA INCORRECTA")</script>';
        echo "<script>location.href='index.html'</script>";
        exit();
    }
} else {
    // Usuario no registrado
    echo '<script>alert("ESTE USUARIO NO EXISTE, POR FAVOR REGÍSTRESE PARA PODER INGRESAR")</script>';
    echo "<script>location.href='registro.php'</script>";
    exit();
}

$stmt->close();
$mysqli->close();
?>
